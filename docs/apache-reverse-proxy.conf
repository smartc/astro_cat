# Apache Reverse Proxy Configuration for AstroCat
#
# This configuration enables HTTPS access to AstroCat through Apache as a reverse proxy.
# All services (main app, database browser, S3 backup) are proxied through port 443.
#
# Prerequisites:
# - Enable Apache modules: proxy, proxy_http, proxy_wstunnel, ssl, rewrite, headers
#   sudo a2enmod proxy proxy_http proxy_wstunnel ssl rewrite headers
#
# Installation:
# 1. Copy this file to /etc/apache2/sites-available/astrocat.conf
# 2. Update ServerName and SSL certificate paths
# 3. Enable the site: sudo a2ensite astrocat
# 4. Test configuration: sudo apachectl configtest
# 5. Reload Apache: sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName your-server.example.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName your-server.example.com

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # Optional: SSLCertificateChainFile /path/to/chain.crt

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Proxy Headers
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # Main AstroCat Application (port 8000)
    # All requests go through the main app, which internally proxies to other services
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/

    # WebSocket support (if needed for real-time features)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://127.0.0.1:8000/$1" [P,L]

    # Increase timeout for long-running operations (backups, etc.)
    ProxyTimeout 300

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/astrocat_error.log
    CustomLog ${APACHE_LOG_DIR}/astrocat_access.log combined
</VirtualHost>

# Optional: WebDAV Direct Access Configuration
#
# If you need direct WebDAV client access (for mounting as network drive),
# you can optionally expose port 8082 through Apache. Note that this requires
# binding WebDAV to 0.0.0.0 instead of 127.0.0.1.
#
# <VirtualHost *:443>
#     ServerName webdav.your-server.example.com
#
#     SSLEngine on
#     SSLCertificateFile /path/to/your/certificate.crt
#     SSLCertificateKeyFile /path/to/your/private.key
#
#     ProxyPreserveHost On
#     ProxyPass / http://127.0.0.1:8082/
#     ProxyPassReverse / http://127.0.0.1:8082/
#
#     # WebDAV requires these headers
#     RequestHeader set X-Forwarded-Proto "https"
# </VirtualHost>

# Alternative: Single port configuration with path-based routing
# Use this if you want to keep all services separate in Apache
#
# <VirtualHost *:443>
#     # ... SSL config ...
#
#     # Main app
#     ProxyPass / http://127.0.0.1:8000/
#     ProxyPassReverse / http://127.0.0.1:8000/
#
#     # The main app now internally proxies these paths:
#     # /db-browser/* -> localhost:8081 (sqlite_web)
#     # /s3-backup/* -> localhost:8083 (S3 backup manager)
#     #
#     # No additional Apache configuration needed for these services!
# </VirtualHost>
