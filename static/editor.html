<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Notes Editor</title>
    <link rel="stylesheet" href="/static/js/lib/easymde.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .header h1 {
            margin: 0;
            flex: 1;
        }
        .header .session-id {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-gray { background: #6b7280; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .editor-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .EasyMDEContainer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .editor-toolbar {
            flex-shrink: 0;
            background: white !important;
            border-bottom: 1px solid #ddd !important;
            border-radius: 8px 8px 0 0;
        }
        .CodeMirror {
            flex: 1 !important;
            height: auto !important;
            border-radius: 0 0 8px 8px;
        }
        .CodeMirror-scroll {
            padding-top: 10px;
        }
        .auto-save {
            color: #10b981;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1 id="session-name">Processing Notes</h1>
            <div class="session-id" id="session-id"></div>
        </div>
        <div class="controls">
            <button id="save-btn" class="btn btn-green">Save Notes</button>
            <span class="auto-save" id="auto-save-status"></span>
        </div>
    </div>
    
    <div class="editor-container">
        <textarea id="editor"></textarea>
    </div>

    <script src="/static/js/lib/easymde.min.js"></script>
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        const sessionName = decodeURIComponent(urlParams.get('session_name') || 'Unknown Session');
        
        // Update page title and header
        document.title = `${sessionName} - Processing Notes`;
        document.getElementById('session-name').textContent = `${sessionName} - Processing Notes`;
        document.getElementById('session-id').textContent = `Session ID: ${sessionId}`;
        
        // Initialize EasyMDE
        const editor = new EasyMDE({
            element: document.querySelector('#editor'),
            spellChecker: false,
            autofocus: true,
            toolbar: [
                'bold', 'italic', 'heading', '|',
                'unordered-list', 'ordered-list', '|',
                'link', 'code', '|',
                'preview', 'side-by-side', 'fullscreen'
            ],
            placeholder: 'Enter your processing session notes here...'
        });
        
        let autoSaveTimer;
        let hasUnsavedChanges = false;
        
        // Track changes for unsaved prompt
        editor.codemirror.on('change', () => {
            hasUnsavedChanges = true;
        });
        
        // Load notes on page load
        async function loadNotes() {
            console.log('Loading notes for session:', sessionId);
            try {
                const response = await fetch(`/api/processing-sessions/${sessionId}/session-info`);
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Loaded content length:', data.content.length);
                    console.log('Setting markdown content...');
                    editor.value(data.content);
                    hasUnsavedChanges = false;
                    console.log('Markdown set successfully');
                } else {
                    console.log('No existing session info, creating default');
                    const defaultContent = `# Processing Session: ${sessionName}

## Processing Notes
Add your processing notes here...

## Processing Checklist
- [ ] Calibration frames applied
- [ ] Stacking completed
- [ ] Background extraction
- [ ] Noise reduction
- [ ] Final processing

## Results
`;
                    editor.value(defaultContent);
                    hasUnsavedChanges = false;
                }
            } catch (error) {
                console.error('Error loading notes:', error);
                editor.value(`# Processing Session: ${sessionName}\n\nAdd your notes here...`);
                hasUnsavedChanges = false;
            }
        }
        
        // Save notes
        async function saveNotes() {
            try {
                document.getElementById('save-btn').disabled = true;
                document.getElementById('save-btn').textContent = 'Saving...';
                
                const content = editor.value();
                
                const response = await fetch(`/api/processing-sessions/${sessionId}/session-info`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(content)
                });
                
                if (response.ok) {
                    hasUnsavedChanges = false;
                    document.getElementById('auto-save-status').textContent = 'Saved!';
                    setTimeout(() => {
                        document.getElementById('auto-save-status').textContent = '';
                    }, 2000);
                } else {
                    console.error('Save failed:', response.status, response.statusText);
                    alert('Failed to save notes');
                }
            } catch (error) {
                console.error('Error saving notes:', error);
                alert('Failed to save notes: ' + error.message);
            } finally {
                document.getElementById('save-btn').disabled = false;
                document.getElementById('save-btn').textContent = 'Save Notes';
            }
        }
        
        // Auto-save every 30 seconds
        function startAutoSave() {
            autoSaveTimer = setInterval(() => {
                if (hasUnsavedChanges) {
                    saveNotes();
                }
            }, 30000);
        }
        
        // Event listeners
        document.getElementById('save-btn').addEventListener('click', saveNotes);
        
        // Prompt before closing if unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveNotes();
            }
        });
        
        // Initialize
        loadNotes();
        startAutoSave();
    </script>
</body>
</html>